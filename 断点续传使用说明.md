# 断点续传功能使用说明

## 功能介绍

程序现在支持**断点续传**功能，即使在处理过程中发生中断（如网络故障、程序崩溃、手动停止等），也可以从上次停止的位置继续处理，避免重复分析已完成的数据。

## 核心特性

1. **自动保存进度**：每处理完一条数据后自动保存进度
2. **智能恢复**：程序启动时自动检测未完成的任务
3. **安全中断**：支持 Ctrl+C 安全中断，进度会被保存
4. **错误恢复**：即使发生异常错误，进度也会被保存

## 使用方法

### 场景1：正常使用（无中断）

1. 运行程序：`python analyze_ai_responses.py`
2. 选择 `1` 开始新的CSV分析
3. 选择CSV文件
4. 程序会自动处理所有数据
5. 完成后自动清除进度文件

### 场景2：中断后恢复

#### 步骤1：任务被中断

任务可能因以下原因中断：
- 按 `Ctrl+C` 手动停止
- 网络连接失败
- API调用异常
- 程序崩溃
- 电脑关机等

**重要**：无论哪种中断方式，已完成的进度都会被保存。

#### 步骤2：恢复处理

1. 再次运行程序：`python analyze_ai_responses.py`

2. 程序会自动检测到未完成的任务，显示类似信息：

```
================================================================================
⚡ 发现未完成的任务！
================================================================================
CSV文件: 数据表.csv
开始时间: 2025-11-21 10:00:00
总数据量: 100 条
已完成: 45 条
剩余: 55 条
上次更新: 2025-11-21 10:30:00
================================================================================
```

3. 在菜单中选择 `R` 从断点继续：

```
请选择操作模式：
⚡ 发现未完成的任务！
R. 从断点继续未完成的任务 (推荐)
----------------------------------------
1. 从CSV文件开始新的分析
2. 选择已有的分析结果进行补足（重新分析失败的条目）
0. 退出

请输入选项 (R/0/1/2): R
```

4. 程序会从第46条数据开始继续处理

5. 完成后自动保存结果并清除进度文件

### 场景3：放弃未完成的任务

如果你想放弃未完成的任务，重新开始：

1. 运行程序
2. 选择 `1` 开始新的分析
3. 程序会警告你：

```
⚠️  警告: 开始新任务将会覆盖当前未完成的进度！
是否确认开始新任务？(y/n):
```

4. 输入 `y` 确认，进度将被清除，开始新任务

## 进度文件说明

### 文件位置
- 文件名：`.analysis_progress.json`
- 位置：程序运行目录

### 文件内容
```json
{
  "csv_file": "数据表.csv",
  "csv_file_abs": "E:\\...\\数据表.csv",
  "start_time": "2025-11-21 10:00:00",
  "total": 100,
  "processed": 45,
  "results": [...],
  "rows_data": [...],
  "last_update": "2025-11-21 10:30:00"
}
```

### 注意事项
- 该文件会自动创建和删除，无需手动管理
- 已添加到 `.gitignore`，不会被提交到版本控制
- 如果手动删除此文件，将无法恢复进度

## 常见问题

### Q1：如何知道当前进度？
**A**：每处理完一条数据后，控制台会显示：
```
✓ 进度已保存 (45/100)
```

### Q2：进度文件会占用很多空间吗？
**A**：会占用一定空间，因为需要保存所有原始CSV数据和已完成的分析结果。大小取决于数据量，通常几MB到几十MB。

### Q3：可以手动编辑进度文件吗？
**A**：不建议手动编辑。如果文件损坏，程序会自动忽略并提示重新开始。

### Q4：如果我移动或重命名了CSV文件怎么办？
**A**：程序会检测CSV文件是否存在，如果不存在会自动清除进度文件。

### Q5：中断会丢失当前正在处理的那一条数据吗？
**A**：是的。进度是在每条数据**处理完成后**才保存的。如果在处理某条数据时中断，该条数据会在恢复后重新处理。

### Q6：可以同时处理多个CSV文件吗？
**A**：目前只支持一个任务。如果开始新任务，会覆盖原有进度。建议先完成当前任务再开始新任务。

## 最佳实践

1. **长时间任务**：对于大量数据（100条以上），建议使用断点续传功能
2. **定期检查**：可以随时按 `Ctrl+C` 暂停，稍后继续
3. **网络不稳定**：如果网络不稳定，可以多次中断和恢复，避免从头开始
4. **测试环境**：在正式处理大量数据前，可以用小数据集测试断点续传功能

## 技术细节

### 保存时机
- 每条数据分析完成后立即保存
- 包括分析失败的数据（标记为失败状态）
- 跳过的空数据也会更新进度

### 错误处理
- `KeyboardInterrupt` (Ctrl+C)：捕获并保存进度
- 其他异常：捕获、保存进度、显示错误信息
- API调用失败：单条数据标记为失败，但继续处理后续数据

### 数据完整性
- 保存的结果包含所有字段
- 保留原始CSV的序号和填写人信息
- 最终输出的JSON文件与不中断时完全一致

## 更新日志

### v2.0 - 2025-11-21
- ✨ 新增：断点续传功能
- ✨ 新增：进度实时保存
- ✨ 新增：智能任务恢复
- 🔧 优化：错误处理机制
- 📝 更新：用户界面提示

---

如有问题或建议，请联系开发者。

